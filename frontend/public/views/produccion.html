<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Producciones Agrícolas</title>
  <!-- Estilos principales -->
  <link rel="stylesheet" href="/frontend/public/css/pages/Normalize.css">
  <link rel="stylesheet" href="/frontend/public/css/pages/produccion.css">
  <link rel="stylesheet" href="/frontend/public/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <aside class="sidebar"></aside>
  <div class="produccion">
    <header class="produccion__header">
      <h1 class="produccion__title">Gestión de Producciones Agrícolas</h1>
      <div class="produccion__actions">
        <button id="crearProduccionBtn" class="produccion__button produccion__button--primary">
          <i class="fas fa-plus"></i> Crear Producción
        </button>
      </div>
    </header>

    <nav class="produccion__tabs">
      <button data-tab="listar" class="produccion__tab produccion__tab--active">Listar</button>
      <button data-tab="estado" class="produccion__tab">Estado</button>
      <button data-tab="reportes" class="produccion__tab">Reportes</button>
    </nav>

    <main class="produccion__content">
      <section id="listar" class="produccion__section produccion__section--active">
        <table class="produccion__table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Cultivo</th>
              <th>Insumos</th>
              <th>Responsable</th>
              <th>Fecha de Inicio</th>
              <th>Fecha de Fin</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="produccionesTableBody"></tbody>
        </table>
      </section>

      <section id="estado" class="produccion__section">
        <p>Habilitar/Deshabilitar</p>
      </section>

      <section id="reportes" class="produccion__section">
        <p>Generar Reportes</p>
      </section>
    </main>
  </div>

  <!-- Modal Crear Producción -->
  <div id="modalCrearProduccion" class="modal">
    <div class="modal__content">
      <button class="modal__close">&times;</button>
      <h2>Crear Producción</h2>
      <form id="crearProduccionForm" class="modal-form">
        <div class="form-group">
          <label for="produccionId">ID Producción</label>
          <input id="produccionId" disabled>
        </div>
        <div class="form-group inline-group">
          <label for="responsable">Responsable</label>
          <select id="responsable"></select>
          <button type="button" id="agregarResponsableBtn" class="btn-small"><i class="fas fa-plus"></i></button>
        </div>
        <div class="form-group">
          <label for="nombreProduccion">Nombre de Producción</label>
          <input id="nombreProduccion" placeholder="Ingrese un nombre">
          <span id="nombreError" class="error-message"></span>
        </div>
        <div class="form-group inline-group">
          <label for="cultivo">Cultivo</label>
          <select id="cultivo"></select>
          <button type="button" id="agregarCultivoBtn" class="btn-small"><i class="fas fa-plus"></i></button>
        </div>
        <div class="form-group inline-group">
          <label for="cicloCultivo">Ciclo</label>
          <select id="cicloCultivo"></select>
          <button type="button" id="agregarCicloBtn" class="btn-small"><i class="fas fa-plus"></i></button>
        </div>
        <div class="form-group inline-group">
          <label for="sensores">Sensores (máx 3)</label>
          <select id="sensores" multiple size="3"></select>
          <button type="button" id="agregarSensorBtn" class="btn-small"><i class="fas fa-plus"></i></button>
          <span id="sensoresError" class="error-message"></span>
        </div>
        <div class="form-group inline-group">
          <label for="insumos">Insumos</label>
          <select id="insumos" multiple size="3"></select>
          <button type="button" id="agregarInsumoBtn" class="btn-small"><i class="fas fa-plus"></i></button>
        </div>
        <div class="form-group">
          <label for="fechaInicio">Fecha Inicio</label>
          <input id="fechaInicio" type="text" placeholder="DD/MM/YYYY">
        </div>
        <div class="form-group">
          <label for="fechaFin">Fecha Fin</label>
          <input id="fechaFin" type="text" placeholder="DD/MM/YYYY">
        </div>
        <div class="form-group">
          <label>Inversión</label>
          <span id="inversionEstimada" class="form-value">$0</span>
        </div>
        <div class="form-group">
          <label>Meta</label>
          <span id="metaEstimada" class="form-value">$0</span>
        </div>

        <div class="modal__actions">
          <button type="button" id="guardarBorrador" class="produccion__button produccion__button--secondary">
            Guardar Borrador
          </button>
          <button type="button" id="crearProduccion" class="produccion__button produccion__button--primary" disabled>
            Crear Producción
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/frontend/JS/sidebar.js"></script>
  <script>
    let producciones = [];
    
    // Función para generar ID
    function generarId() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = now.getFullYear();
      const count = producciones.filter(p => p.id.startsWith(`PROD-${dd}${mm}${yyyy}`)).length + 1;
      return `PROD-${dd}${mm}${yyyy}-${String(count).padStart(4, '0')}`;
    }
  
    // Al cargar el documento
    document.addEventListener('DOMContentLoaded', async function () {
      const btnAbrir = document.getElementById('crearProduccionBtn');
      const modal = document.getElementById('modalCrearProduccion');
      const nombreInput = document.getElementById('nombreProduccion');
      const nombreError = document.getElementById('nombreError');
      const guardarBtn = document.querySelector('.produccion__button--primary');
  
      if (btnAbrir) {
        btnAbrir.addEventListener('click', () => {
          document.getElementById('produccionId').value = generarId();
          flatpickr('#fechaInicio', { defaultDate: 'today', dateFormat: 'd/m/Y' });
          flatpickr('#fechaFin', { dateFormat: 'd/m/Y' });
          modal.style.display = 'flex';
        });
      }
  
      document.querySelectorAll('.modal__close').forEach(btn =>
        btn.addEventListener('click', () => modal.style.display = 'none')
      );
  
      // Validación del nombre de la producción
      nombreInput.addEventListener('input', () => {
        const v = nombreInput.value.trim();
        const msg = v.length < 3 ? 'Mínimo 3 caracteres.' :
          v.length > 100 ? 'Máximo 100 caracteres.' :
            !/[A-Za-z]/.test(v) ? 'Debe contener al menos una letra.' :
              producciones.some(p => p.nombre.toLowerCase() === v.toLowerCase()) ? 'Nombre ya existe.' : '';
        nombreError.textContent = msg;
        document.getElementById('crearProduccion').disabled = !!msg;
      });
  
      // Crear producción
      document.getElementById('crearProduccion').addEventListener('click', () => {
        const nueva = {
          id: document.getElementById('produccionId').value,
          nombre: nombreInput.value.trim(),
          cultivo: document.getElementById('cultivo').value
        };
        producciones.push(nueva);
        const row = document.createElement('tr');
        row.innerHTML = `<td>${nueva.id}</td><td>${nueva.nombre}</td><td>${nueva.cultivo}</td><td>Ver | Editar</td>`;
        document.getElementById('produccionesTableBody').appendChild(row);
        modal.style.display = 'none';
      });
  
      // Cargar datos en los selects
      async function fetchAndPopulateSelect(url, selectId) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Seleccione</option>';
            data.forEach(item => {
              const option = document.createElement('option');
              option.value = item.id;
              option.textContent = item.rol; // Aquí debe ser lo que quieras mostrar (por ejemplo, el nombre o el rol)
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error(`Error cargando ${selectId}:`, error);
        }
      }

      // Llamadas a la API para cargar datos en los selects
      await fetchAndPopulateSelect('/api/usuarios?rol=responsable', 'responsable');
      await fetchAndPopulateSelect('/api/ciclos', 'cicloCultivo');
      await fetchAndPopulateSelect('/api/sensores', 'sensores');
      await fetchAndPopulateSelect('/api/insumos', 'insumos');
    });
  </script>
</body>

</html>
